## 1 库
库是提供特定功能的，成熟的可复用的代码，printf 函数就是C语言的`标准库`函数，库的重要性不言而喻。
- 静态库 `Linux - .a`    `Windows - .lib`
- 动态库 `Linux - .so`  `Windows - .dll`

> [!Note]
> 库本质上也是一种可执行代码的二进制形式，可以被操作系统拉到内存中执行
### 1.1 静态库
静态库本质就是**一些可重定向文件的集合**，所以在操作系统看来一个可执行文件有没有使用静态库是没有任何影响的
> [!Note]
> 一个可执行程序可能混合依赖静态库和动态库，编译默认动态链接库，只有找不到对应动态库时才会静态链接同名静态库，gcc 的 -`-static`选项可以强制优先静态链接静态库
#### 生成静态库
1. 将 C 源码编译为目标文件  `gcc -c 源文件.c`
2. 使用 GNU 的归档工具 ar，将多个 .o 文件打包成一个文件  `ar -rc libmystdio.a my_stdio.o my_string.o`
3. 生成后可以使用 ar 工具查看库里面包含的 .o 文件  `ar -tv libmystdio.a`
- `-t`：显示压缩包/归档文件中的内容列表。
- `-v`：显示详细信息。
#### 使用静态库
若可执行程序依赖某个静态库，则需要在编译时指明：
- `-l` 指定库名，去掉文件后缀与`lib`前缀即为库名
- `-I` 指定头文件搜索路径
- `-L` 指定库路径
### 1.2 动态库
如果程序依赖动态库，则程序`运行时`需要链接动态库
- 在程序运行之前加载动态库进内存并使用页表映射的过程被称作`动态链接`
- 把动态库加载进内存只需要加载程序用到的其中函数的地址，而不是函数所在目标文件的所有机器码
- 若多个进程程序都需要使用同一动态库，相比于臃肿的静态库，动态库只需要被加载进物理内存一份，每个进程的页表自己去映射虚拟地址就行了，节省了内存空间
#### 生成动态库
1. 将 C 源码编译为“位置无关”的目标文件
   - `gcc -fPIC -c 源文件.c`
   - `-fPIC` 生成位置无关代码
2. 链接生成动态库
   - `gcc -o libmystdio.so my_stdio.o my_string.o -shared`
   - `-shared` 表示生成共享库格式，也就是动态库格式
3. 运行时搜索动态库目录
   - 拷⻉ `动态库` ⽂件到系统共享库路径下,⼀般指 `/usr/lib`、`/usr/local/lib`、`/lib64` 或者开篇指明的库路径等
   - 向**系统**动态库路径下提供库同名软链接
   - 更改 `LD_LIBRARY_PATH` 环境变量
## 2. ELF文件
以下四种文件皆为`ELF`格式文件
- 可重定位文件/目标文件 `xxx.o`
- 可执行文件
- 动态库文件 `xxx.so`
- 内核转储
### 2.1 介绍ELF格式
```ascii
+----------------------------------+
|                                  |
|            ELF Header            |
|                                  |
+----------------------------------+
|                                  |
|    Program Header Table (可选)   |
|                                  |
+----------------------------------+
|                                  |
|            Section 1             |
|                                  |
+----------------------------------+
|                                  |
|            Section 2             |
|                                  |
+----------------------------------+
|                                  |
|               ...                |
|                                  |
+----------------------------------+
|                                  |
|            Section n             |
|                                  |
+----------------------------------+
|                                  |
|       Section Header Table       |
|                                  |
+----------------------------------+
```
### 2.2 节头表
### 2.3 段头表
## 3. 深入链接与加载

### 3.2 动态库加载
### 3.3 动态链接